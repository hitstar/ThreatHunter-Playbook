# In-Memory Mimikatz Logonpasswords

## Playbook ID

EW002

## Author

Roberto Rodriguez [@Cyb3rWard0g](https://twitter.com/Cyb3rWard0g)

## Technique ID

T1003

## Hypothesis

Adversaries might be reflectively loading Mimikatz into Memory and using. Adversaries might attempt to pull the NTLM hash of a user via active directory replication apis from a non-domain-controller account with permissions to do so.

## Attack Knowledge

### Active Directory Replication

Active Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.

Active Directory data takes the form of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. The values of the attributes define the object, and a change to a value of an attribute must be transferred from the domain controller on which it occurs to every other domain controller that stores a replica of that object.

An adversary can abuse this model and request information about a specific account via the replication request. This is done from an account with permissions to perform that request. Usually you will see the domain controller account (i.e dcaccount$) doing this which might be an anomaly to see other non-dc-accounts doing it.

The following access rights / permissions are needed for the replication request according to the domain functional level:

| Control access right symbol | Identifying GUID used in ACE |
|-----------------------------|------------------------------|
| DS-Replication-Get-Changes | 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2 |
| DS-Replication-Get-Changes-All | 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2 |
| DS-Replication-Get-Changes-In-Filtered-Set | 89e95b76-444d-4c62-991a-0facbeda640c |

More information about the control access rights can be found [here](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb)

### DC-to-DC Directory Replication Operations

The interaction between DC-to-DC for directory replication service (DRS) remote protocol operations are implemented via a service principal name (SPN) with service class "E3514235-4B06-11D1-AB04-00C04FC2DCD2". This is because when a DC wants to connect to another DC in a particular domain for DRS operations, the DC constructs the following SPN:

[<DRS interface GUID>/<DSA GUID>/<DNS domain name>](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/41efc56e-0007-4e88-bafe-d7af61efd91f)

[<DRS interface GUID>](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/41efc56e-0007-4e88-bafe-d7af61efd91f) is the fixed Directory Replication Service (DRS) RPC interface GUID, which has the well-known value of "E3514235-4B06-11D1-AB04-00C04FC2DCD2".

### Directory Replication Service (DRS) RPC Remote Protocol

The Directory Replication Service (DRS) Remote Protocol is an RPC protocol for replication and management of data in Active Directory. When an adversary utilizes directory replication services to connect to a DC, you will see an RPC Client call operation with the RPC Interface GUID of `E3514235-4B06-11D1-AB04-00C04FC2DCD2` pointing to the targeted DC. This activity is recorded at the source endpoint (from where the DCSync technique is being performed from) with events from the `Microsoft-Windows-RPC` ETW provider. Even though the `Microsoft-Windows-RPC` ETW provider provides great visibility for replication operations at the source endpoint level, it does not have an event tracing session writing events to an .evtx file which does not make it practical to use at scale yet.

### Domain Controller Auditing and Directory Replication Services

Events generated by the replication activity on the targeted DC are available and easy to collect at scale. These events are related to the replication access control performed by the targeted DC and provided via event id [4662 from the security log channel](https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/security/threat-protection/auditing/event-4662.md). Events from the Security log channel of id 4662 are generated every time an operation is performed on an Active Directory object. The main operation performed for AD replication purposes is categorized as `Object Access`. When an adversary performs a replication operation against a DC, the type of active directory object being accessed is of class [Domain-DNS](https://docs.microsoft.com/en-us/windows/desktop/adschema/c-domaindns) and points to the root domain distinguished name (i.e DC=shire,DC=com) or GUID. Event 4662 displays the AD object class with its `Ldap-Display-Name domainDNS` value or `Schema-Id-Guid 19195a5b-6da0-11d0-afd3-00c04fd930c9`. In addition, the type of access in event 4662 is provided by the `access mask` field and it is of value `0x100` which translates to access type `Control Access`. The access type `Control Access` allows adversary to have access to the AD object only after extended rights checks supported by the object are performed. Here is where the replication extended rights from the table above are checked and captured by event 4662. Those extended rights are captured in the `properties` field.

The `Properties` field in 4662 provides two things, the first part is the type of access that was used. Typically has the same value as `Accesses field` which in this case is simply `Control Access`. The second part is a tree of GUID values of Active Directory classes or property sets, for which operation was performed. In our case we see the extended rights guid first and then the GUID of the class `Domain-DNS`. Therefore, when looking for this type of activity in event logs produced by the targeted DC, it is easy to find replication extended rights in event 4662.

Remember that adversaries willing to perform a DCSync attack, could also use other domain accounts to perform the task, despite being in no privileged groups, having no malicious sidHistory, and not having local admin rights on the domain controller itself. An adversary will just need to add the three ad replication access rights shown in the table above to the unprivileged account.

## Attack Emulation Dataset

| RT Platform  | Dataset | Author |
|---------|---------|---------|
| Empire | [empire_dcsync](https://github.com/Cyb3rWard0g/mordor/blob/master/small_datasets/windows/credential_access/credential_dumping_T1003/credentials_from_ad/empire_dcsync.md) | Roberto Rodriguez [@Cyb3rWard0g](https://twitter.com/Cyb3rWard0g) |

## Attack Detection Events

| Event ID | Event Name | Log Provider | Audit Category | Audit Sub-Category | ATT&CK Data Source |
|---------|---------|----------|----------|---------|
| [4662](https://github.com/Cyb3rWard0g/OSSEM/blob/master/data_dictionaries/windows/security/events/event-4662.md) | An operation was performed on an object | Microsoft-Windows-Security-Auditing | Audit DS Access | Audit Directory Service Access | Windows Event Logs |
| 1 | RpcServerCall/Start | Microsoft-Windows-RPC | | | |

## Analytic(s) Relationships

| Data Object | Relationship | Data Object | Event ID |
|--------|---------|-------|--------|
|  user | accessed | ad object | 4662 |

## Data Analytics

| Analytic Platform | Analytic Type  | Analytic Logic |
|--------|---------|---------|
| Kibana | Rule | event_id:4662 NOT user_name:*$ AND object_access_mask_requested:"0x100" AND object_properties:("*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*" OR "*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*" OR "*89e95b76-444d-4c62-991a-0facbeda640c*") |

## Potential False Positives

* Adversary is using an account that is not a domain controller but authorized and currently performing active directory replication tasks as part of daily operation.

## Hunter Notes

* The `Microsoft-Windows-RPC` provider does not have an event tracing session writing events to an .evtx file. Therefore, collection of those events does not scale yet.

## References

* https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb
* https://docs.microsoft.com/en-us/windows/desktop/adschema/c-domain
* https://docs.microsoft.com/en-us/windows/desktop/adschema/c-domaindns
* http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/
* https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc782376(v=ws.10)
* https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47



## Description


Mimikatz Command: 
* sekurlsa::LogonPasswords : lists all available provider credentials. This usually shows recently logged on user and computer credentials.

Monitoring OpenProcess() : [dim0x69 - blog.3or.de](https://blog.3or.de/hunting-mimikatz-with-sysmon-monitoring-openprocess.html)

| module | OpenProcess caller function | destination process / destination service | ACCESS\_MASK | ACCESS\_MASK translated | comment |
|---------|---------|---------|---------|---------|---------|
| sekurlsa::* | kuhl\_m\_sekurlsa\_acquireLSA() | lsass.exe | PROCESS\_VM\_READ \| PROCESS\_QUERY\_INFORMATION | 0x1410 | for Windows Version < 5 |
| sekurlsa::* | kuhl\_m\_sekurlsa\_acquireLSA() | lsass.exe | PROCESS\_VM\_READ \| PROCESS\_QUERY\_LIMITED\_INFORMATION | 0x1010 | for Windows Version >= 6 |


## Hypothesis
Adversaries might be executing Mimikatz in memory with the help of PowerShell in order to dump credentials in my environment.


## Attack Simulation


| Script  | Short Description | Author | 
|---------|---------|---------|
| [mimikatz](https://github.com/gentilkiwi/mimikatz)| Credential dumper | [Benjamin Delpy](http://blog.gentilkiwi.com/) |


## Recommended Data Sources

| ATT&CK Data Source | Event Log | Description |
|---------|---------|---------|
|Process Monitoring| Sysmon | Process access | 
|Process Monitoring| Sysmon | Image Loaded
|PowerShell Logs| PowerShell | Module Logging |
|PowerShell Logs| PowerShell | Script-Block Logging |
|Sensitive Privilege Use| Windows Security Auditing |Audit Sensitive Privilege Use |

## Specific Events

| Source | EventID | EventFields | Details | Reference | 
|--------|---------|-------|--------|-----------| 
| Sysmon | 10 | GrantedAccess | 0x1010, 0x1410 | [Cyb3rWard0g](https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html) |
| Sysmon | 10 | GrantedAccess | 0x1438, 0x143a, 1418 | [dim0x69 - blog.3or.de](https://blog.3or.de/hunting-mimikatz-with-sysmon-monitoring-openprocess.html) |
| Sysmon | 10 | SourceImage | powershell.exe OR ANY | [Cyb3rWard0g](https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html) |
| Sysmon | 10 | TargetImage | lsass.exe | [Cyb3rWard0g](https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html) |
| Sysmon | 10 | CallTrace | \\\ntdll\\.dll\\+\[a-zA-Z0-9\]\{1,\}\|\\\KERNELBASE\\.dll\\+\[a-zA-Z0-9\]\{1,\}\|UNKNOWN\(\[a-zA-Z0-9\]\{16\}\) | [Cyb3rWard0g](https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html) |
| Sysmon | 7 | ImageLoaded | WinSCard.dll, cryptdll.dll, hid.dll, samlib.dll, vaultcli.dll, WMINet_Utils.dll (Optional) | [Cyb3rWard0g](https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for.html) |

## Recommended Configuration(s)
| Title | Description | Reference|
|---------|---------|---------|
| Mimikatz | Sysmon configuration | [T1003\_mimikatz\_inmem.xml](https://github.com/Cyb3rWard0g/ThreatHunter-Playbook/blob/master/attack_matrix/windows/sysmon_configs/T1003_mimikatzinmem.xml)
|  Audit Sensitive Privilege Use | You will need to enable an Audit Policy of Privilege Use Category -> Sub-category Audit Sensitive Privilege Use | [Microsoft](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4673#security-monitoring-recommendations) |


## Data Analytics 

| Analytic Type  | Analytic Logic | Analytic Data Object |
|--------|---------|---------|
| Anomaly/Outlier | process WHERE target\_process\_name == "lsass.exe" AND process\_granted\_access == "*" COUNT BY process\_name  | [process](https://github.com/Cyb3rWard0g/OSSEM/blob/c0bf44fb8c527f6e678c4ff1321814108e024315/detection_data_model/data_objects/process.md) |



## Hunter Notes
* GrantedAccess code 0x1010 is the new permission Mimikatz v.20170327 uses for command "sekurlsa::logonpasswords"
  * 0x00000010 = VMRead
  * 0x00001000 = QueryLimitedInfo
* GrantedAccess code 0x1010 is less common than 0x1410
* Out of all the Modules that Mimikatz needs to function, the 5 above are the ones with less false positives
* WMINet_Utils.dll is optional since it is loaded by scripts developed by PowerSploit and Empire projects (Invoke-Mimikatz.ps1).
* Look for PowerShell.exe (Suspicious) or other processes accessing Lsass.exe with a potential CallTrace Pattern: C:\\Windows\\SYSTEM32\\ntdll\.dll\+[a-zA-Z0-9]{1,}\|C:\\Windows\\system32\\KERNELBASE\.dll\+[a-zA-Z0-9]{1,}\|UNKNOWN\([a-zA-Z0-9]{16}\)
	* Remember that an attacker can easily run Mimikatz or other credential dumping tool under a different process. This hypothesis is focusing on PowerShell as a process hosting the script. However, you can change this hypothesis to look for other Microsoft signed binaries or any process in the system. The idea is to focus on the patterns of behavior.
* The values for the GrantedAccess field in Sysmon EID 10 besides 0x1010 & 0x140 are other permissions needed for several of the modules used by Mimikatz. The following table lists most of the calls to OpenProcess() with the opened service / process name and the associated ACCESS_MASK.

| module | OpenProcess caller function | destination process / destination service | ACCESS\_MASK | ACCESS_MASK translated | comment |
|---------|---------|---------|---------|---------|---------|
| lsadump::lsa /patch | kuhl\_m\_lsadump\_lsa\_getHandle() | SamSs | PROCESS\_VM\_READ \| PROCESS\_VM_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 |
| lsadump::lsa /inject | kuhl\_m\_lsadump\_lsa\_getHandle() | SamSs | PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE  \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION \| PROCESS\_CREATE\_THREAD | 0x143a |
| lsadump::trust /patch | kuhl_m_lsadump_lsa_getHandle() | SamSs | PROCESS_VM_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION| 0x1438 |
| minesweeper::infos | kuhl\_m\_minesweeper\_infos() | minesweeper.exe | PROCESS\_VM\_READ \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1418 |
| misc:detours | kuhl\_m\_misc\_detours\_callback\_process() | * |GENERIC\_READ | |omitted because of the very generic ACCESS_MASK |
| misc:memssp |  kuhl\_m\_misc\_memssp() | lsass.exe | PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 |
| process::suspend, process:stop, process:resume,process:imports, process:exports |kuhl\_m\_process\_genericOperation()|||| omitted because of the very generic ACCESS_MASKs|
| vault::cred /patch|  kuhl\_m\_vault\_cred() | SamSs | PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 | |
| token::list, token::elevate, token::run | querying all processes on the system |*||first 0x1400 then 0x40| all three commands result in a call to kull\_m\_token\_getTokens() which first iterates over **all** processes and threads with OpenProcess(PROCESS\_QUERY\_INFORMATION (0x1400)) (kull\_m\_token\_getTokens\_process\_callback()) and then again to get the tokens OpenProcess(PROCESS\_DUP\_HANDLE (0x40)) (in kull\_m\_handle\_getHandlesOfType_callback()) to duplicate the Tokens. This results in many thousand (!) Events with ID 10 (!)|
| crypto::cng | kull\_m\_patch\_genericProcessOrServiceFromBuild() via  kuhl\_m\_crypto\_p\_cng() |KeyIso | PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 | |
| event::drop | kull\_m\_patch\_genericProcessOrServiceFromBuild() via  kuhl\_m\_event\_drop() | EventLog | PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 | ** this event does not get logged! :O mimikatz seems to be fast enough to apply the patch before the event gets logged!**|
| misc::ncroutemon | kull\_m\_patch\_genericProcessOrServiceFromBuild() via  kuhl\_m\_misc\_ncroutemon() | dsNcService| PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 | |
| ts::multirdp| kull\_m\_patch\_genericProcessOrServiceFromBuild() via  kuhl\_m\_ts\_multirdp() | TermService | PROCESS\_VM\_READ \| PROCESS\_VM\_WRITE \| PROCESS\_VM\_OPERATION \| PROCESS\_QUERY\_INFORMATION | 0x1438 | 

* You could use a stack counting technique to stack all the values of the permissions invoked by processes accessing Lsass.exe. You will have to do some filtering to reduce the number of false positives. You could then group the results with other events such as modules being loaded (EID 7). A time window of 1-2 seconds could help to get to a reasonable number of events for analysis.


## Hunting Techniques Recommended

- [x] Grouping
- [x] Searching
- [ ] Clustering
- [x] Stack Counting
- [ ] Scatter Plots
- [ ] Box Plots
- [ ] Isolation Forest
